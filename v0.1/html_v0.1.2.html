<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    body {
      font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”";
      margin: 10px;
      font-size: 13px;
    }
    .row {
      margin-bottom: 8px;
    }
    label {
      display: inline-block;
      width: 70px;
    }
    select, button {
      padding: 6px;
      font-size: 13px;
    }
    #gridWrap {
      overflow: auto;
      max-height: 500px;
      border: 1px solid #ddd;
      padding: 8px;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 80px;
      text-align: center;
    }
    th.date {
      background: #f6f6f6;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .loading-btn {
      position: relative;
      overflow: hidden;
    }
    
    .loading-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: loading-sweep 1.5s infinite;
    }
    
    @keyframes loading-sweep {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .btn-error {
      background-color: #ffebee !important;
      animation: btn-error-shake 0.5s ease-in-out;
    }
    
    @keyframes btn-error-shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
</style>
</head>
<body>
<h3>å»£é’é›²ç«¯å…¨å»£å¤§èª²é»åç³»çµ±ï¼ˆWebï¼‰</h3>

<div class="row">
<label>çµ„åˆ¥</label>
<select id="groupSel"></select>
</div>

<div class="row">
<label>æœˆä»½</label>
<select id="monthSel"></select>
</div>

<div class="row">
<button onclick="loadGrid()">ç”¢ç”Ÿäº’å‹•è¡¨æ ¼</button>
<button onclick="saveAll()">å„²å­˜</button>
<button onclick="clearGrid()">æ¸…é™¤è¡¨æ ¼</button>
</div>

<div id="gridWrap"><div id="grid"></div></div>
<div id="msg" class="small"></div>

<script>
  let meta={students:[],dates:[],attendanceMap:{}};

  // ğŸ¯ æŒ‰éˆ•é…ç½®è¡¨
  const BUTTON_CONFIG = {
    'ç”¢ç”Ÿäº’å‹•è¡¨æ ¼': {
      loading: 'ç”¢ç”Ÿä¸­...',
      loadingRecord: 'è¼‰å…¥è¨˜éŒ„ä¸­...',
      original: 'ç”¢ç”Ÿäº’å‹•è¡¨æ ¼'
    },
    'å„²å­˜': {
      loading: 'å„²å­˜ä¸­...',
      reloading: 'é‡æ–°è¼‰å…¥ä¸­...',
      original: 'å„²å­˜'
    },
    'æ¸…é™¤è¡¨æ ¼': {
      loading: 'æ¸…é™¤ä¸­...',
      original: 'æ¸…é™¤è¡¨æ ¼'
    }
  };

  // ğŸ¯ æ–°å¢ï¼šæŒ‰éˆ•ç‹€æ…‹ç®¡ç†å‡½æ•¸
  function setButtonStates(activeButtonText, loadingText) {
    const buttons = document.querySelectorAll('button');
    
    buttons.forEach(btn => {
      const currentText = btn.textContent;
      
      if (currentText === activeButtonText || btn.textContent === loadingText) {
        // ç•¶å‰æ´»å‹•æŒ‰éˆ•ï¼šç¦ç”¨ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        btn.disabled = true;
        btn.textContent = loadingText;
        btn.classList.add('loading-btn');
        btn.style.opacity = '0.8';
        btn.style.cursor = 'not-allowed';
      } else {
        // å…¶ä»–æŒ‰éˆ•ï¼šç¦ç”¨ä¸¦è®Šç°
        btn.disabled = true;
        btn.style.opacity = '0.4';
        btn.style.cursor = 'not-allowed';
        btn.style.backgroundColor = '#f5f5f5';
        btn.style.color = '#999';
      }
    });
  }

  // ğŸ¯ æ¢å¾©æ‰€æœ‰æŒ‰éˆ•æ­£å¸¸ç‹€æ…‹ï¼ˆç§»é™¤é‡è¤‡ï¼Œåªä¿ç•™ä¸€å€‹ï¼‰
  function resetButtonStates() {
    const buttons = document.querySelectorAll('button');
    
    buttons.forEach(btn => {
      btn.disabled = false;
      btn.classList.remove('loading-btn', 'btn-error');
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btn.style.backgroundColor = '';
      btn.style.color = '';
      
      // ğŸ¯ æ™ºæ…§æ–‡å­—æ¢å¾©ï¼ˆåŒ…å«æ–°çš„é‡æ–°è¼‰å…¥ç‹€æ…‹ï¼‰
      const currentText = btn.textContent;
      
      // éæ­·é…ç½®è¡¨æ‰¾åˆ°å°æ‡‰çš„åŸå§‹æ–‡å­—
      for (const [originalText, config] of Object.entries(BUTTON_CONFIG)) {
        if (currentText === config.loading || 
            currentText === config.loadingRecord || 
            currentText === config.reloading ||
            currentText === originalText) {
          btn.textContent = config.original;
          break;
        }
      }
    });
  }

  // ğŸ¯ æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼ˆç”¨æ–¼è¼‰å…¥è¨˜éŒ„éšæ®µï¼‰
  function updateButtonText(fromText, toText) {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (btn.textContent === fromText) {
        btn.textContent = toText;
      }
    });
  }
  
  // ğŸ¯ éŒ¯èª¤ç‹€æ…‹è™•ç†
  function setButtonError(buttonText) {
    const buttons = document.querySelectorAll('button');
    const errorBtn = Array.from(buttons).find(btn => 
      btn.textContent === buttonText || 
      btn.onclick?.toString().includes(buttonText)
    );
    
    if (errorBtn) {
      errorBtn.classList.add('btn-error');
      setTimeout(() => {
        if (errorBtn) {
          errorBtn.classList.remove('btn-error');
        }
      }, 3000);
    }
  }
  
  function init(){
    google.script.run.withSuccessHandler(popGroups).getGroups();
    google.script.run.withSuccessHandler(popMonths).getMonths();
    document.getElementById('msg').innerText='è«‹é¸çµ„åˆ¥èˆ‡æœˆä»½';
  }
  
  function popGroups(groups){
    const sel=document.getElementById('groupSel');
    sel.innerHTML='<option value="">(è«‹é¸çµ„åˆ¥)</option>';
    groups.forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.text=g; sel.appendChild(opt); });
  }
  
  function popMonths(months){
    const sel=document.getElementById('monthSel');
    sel.innerHTML='<option value="">(è«‹é¸æœˆä»½)</option>';
    months.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.text=m; sel.appendChild(opt); });
  }
  
  function loadGrid(){
      const group=document.getElementById('groupSel').value;
      const month=document.getElementById('monthSel').value;
      if(!group||!month){ 
        document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; 
        return; 
      }
      
      // ğŸ¯ ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼Œç•¶å‰æŒ‰éˆ•é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      setButtonStates('ç”¢ç”Ÿäº’å‹•è¡¨æ ¼', 'ç”¢ç”Ÿä¸­...');
      document.getElementById('msg').innerText='è¼‰å…¥ä¸­...';
      meta.students=[]; meta.dates=[];
  
      let studentsLoaded = false;
      let datesLoaded = false;
  
      // å‘¼å«1: è¼‰å…¥å­¸ç”Ÿè³‡æ–™
      google.script.run
        .withSuccessHandler(students=>{
          console.log('æˆåŠŸè¼‰å…¥å­¸ç”Ÿè³‡æ–™:', students);
          meta.students=students; 
          studentsLoaded = true;
          if(datesLoaded) {
            buildGrid();
          }
        })
        .withFailureHandler(error=>{
          console.error('è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:', error);
          document.getElementById('msg').innerText='è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—: ' + error.message;
          resetButtonStates();
          setButtonError('loadGrid');
        })
        .getStudentsByGroup(group);
      
      // å‘¼å«2: è¼‰å…¥æ—¥æœŸè³‡æ–™  
      google.script.run
        .withSuccessHandler(dates=>{
          console.log('æˆåŠŸè¼‰å…¥æ—¥æœŸè³‡æ–™:', dates);
          meta.dates=dates; 
          datesLoaded = true;
          if(studentsLoaded) {
            buildGrid();
          }
        })
        .withFailureHandler(error=>{
          console.error('è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—:', error);
          document.getElementById('msg').innerText='è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—: ' + error.message;
          resetButtonStates();
          setButtonError('loadGrid');
        })
        .getDatesByMonth(month);
  }
  
  function buildGrid(){
    const container = document.getElementById('grid');
    container.innerHTML = '';
    
    // æª¢æŸ¥å­¸ç”Ÿè³‡æ–™
    if(!meta.students.length){ 
      container.innerHTML = '<div class="small">æ­¤çµ„ç„¡å­¸ç”Ÿ</div>'; 
      document.getElementById('msg').innerText = 'æ­¤çµ„ç„¡å­¸ç”Ÿè³‡æ–™';
      resetButtonStates();
      return; 
    }
  
    // æª¢æŸ¥æ—¥æœŸè³‡æ–™
    if(!meta.dates.length){ 
      container.innerHTML = '<div class="small">æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥</div>'; 
      document.getElementById('msg').innerText = 'æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥æœŸ';
      resetButtonStates();
      return; 
    }
  
    const table = document.createElement('table');
    
    // å»ºç«‹è¡¨é ­
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    hr.appendChild(tdEl('å­¸ç±ç·¨è™Ÿ', 'th'));
    hr.appendChild(tdEl('å§“å', 'th'));
    meta.dates.forEach(d => hr.appendChild(tdEl(d, 'th', 'date')));
    thead.appendChild(hr);
    table.appendChild(thead);
  
    // å»ºç«‹è¡¨èº«
    const tbody = document.createElement('tbody');
    meta.students.forEach((s, i) => {
      const tr = document.createElement('tr');
      tr.appendChild(tdEl(s.id));
      tr.appendChild(tdEl(s.name));
      
      meta.dates.forEach(dt => {
        const td = document.createElement('td');
        const sel = document.createElement('select');
        sel.setAttribute('data-student', s.id);
        sel.setAttribute('data-date', dt);
        
        ['', 'è«‹å‡', 'å‡ºå¸­', 'è£œèª²'].forEach(opt => { 
          const o = document.createElement('option'); 
          o.value = opt; 
          o.text = (opt === '' ? 'â€”' : opt); 
          sel.appendChild(o); 
        });
        
        td.appendChild(sel);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
    
    // ğŸ¯ å»ºç«‹è¡¨æ ¼å¾Œï¼Œç¹¼çºŒè¼‰å…¥æ—¢æœ‰è¨˜éŒ„ï¼ˆä¿æŒæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹ï¼‰
    document.getElementById('msg').innerText = `å»ºç«‹è¡¨æ ¼å®Œæˆï¼Œæ­£åœ¨è¼‰å…¥æ—¢æœ‰è¨˜éŒ„...`;
    loadExistingAttendance();
  }
  
  function loadExistingAttendance(){
    const group = document.getElementById('groupSel').value;
    const month = document.getElementById('monthSel').value;
    
    console.log(`é–‹å§‹è¼‰å…¥æ—¢æœ‰è¨˜éŒ„: çµ„åˆ¥=${group}, æœˆä»½=${month}`);
    console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
    
    // ğŸ¯ ä½¿ç”¨æ–°çš„æ›´æ–°å‡½æ•¸
    updateButtonText('ç”¢ç”Ÿä¸­...', 'è¼‰å…¥è¨˜éŒ„ä¸­...');
    
    document.getElementById('msg').innerText = 'æ­£åœ¨è¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„...';
    
    google.script.run
      .withSuccessHandler(records => {
        console.log('æˆåŠŸè¼‰å…¥æ—¢æœ‰è¨˜éŒ„:', records);
        console.log('è¨˜éŒ„æ•¸é‡:', records.length);
        
        if(!records || records.length === 0) {
          console.log('æ²’æœ‰æ‰¾åˆ°æ—¢æœ‰è¨˜éŒ„');
          document.getElementById('msg').innerText = 
            `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œç„¡æ—¢æœ‰è¨˜éŒ„`;
          
          resetButtonStates();
          return;
        }
        
        let loadedCount = 0;
        let notFoundCount = 0;
        
        records.forEach(record => {
          console.log(`è™•ç†è¨˜éŒ„: ${record.studentId} ${record.date} = ${record.status}`);
          
          let targetDate = record.date;
          const matchedDate = meta.dates.find(frontendDate => {
            let frontendDateOnly = frontendDate;
            if (frontendDateOnly.includes('/') && frontendDateOnly.split('/').length === 3) {
              const parts = frontendDateOnly.split('/');
              frontendDateOnly = `${parts[1]}/${parts[2]}`;
            }
            if (frontendDateOnly.includes('(')) {
              frontendDateOnly = frontendDateOnly.split(' ')[0];
            }
            console.log(`æ¯”è¼ƒ: å¾Œç«¯="${record.date}" vs å‰ç«¯="${frontendDateOnly}" (åŸå§‹="${frontendDate}")`);
            return frontendDateOnly === record.date;
          });
          
          if(matchedDate) {
            targetDate = matchedDate;
            console.log(`ğŸ”„ æ—¥æœŸæ ¼å¼è½‰æ›: ${record.date} -> ${targetDate}`);
          } else {
            console.warn(`âŒ æ‰¾ä¸åˆ°åŒ¹é…çš„å‰ç«¯æ—¥æœŸ: ${record.date}`);
            console.warn(`å¯ç”¨çš„å‰ç«¯æ—¥æœŸ:`, meta.dates);
          }
          
          const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
          const sel = document.querySelector(selector);
          
          if(sel) {
            sel.value = record.status;
            sel.style.backgroundColor = '#ffffcc';
            loadedCount++;
            console.log(`âœ“ æˆåŠŸè¨­å®š: ${record.studentId} ${targetDate} = ${record.status}`);
          } else {
            notFoundCount++;
            console.warn(`âœ— æ‰¾ä¸åˆ°å°æ‡‰çš„é¸æ“‡æ¡†: ${record.studentId} ${targetDate}`);
            console.warn(`ä½¿ç”¨çš„é¸æ“‡å™¨: ${selector}`);
            console.warn(`åŸå§‹æ—¥æœŸ: ${record.date}, è½‰æ›å¾Œæ—¥æœŸ: ${targetDate}`);
          }
        });
        
        console.log(`è¼‰å…¥çµæœ: æˆåŠŸ ${loadedCount} ç­†, æ‰¾ä¸åˆ° ${notFoundCount} ç­†`);
        
        let message = `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œ${loadedCount} ç­†æ—¢æœ‰è¨˜éŒ„`;
        if(notFoundCount > 0) {
          message += `ï¼Œ${notFoundCount} ç­†è¨˜éŒ„ç„¡æ³•å°æ‡‰`;
        }
        document.getElementById('msg').innerText = message;
        
        resetButtonStates();
      })
      .withFailureHandler(error => {
        console.error('è¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('msg').innerText = 
          `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼ˆè¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—: ${error.message})`;
        
        resetButtonStates();
        setButtonError('loadGrid');
      })
      .getExistingAttendance(group, month);
  }
  
  function tdEl(txt, tag, className){ 
    const el = document.createElement(tag || 'td'); 
    el.innerText = txt; 
    if(className) el.className = className;
    return el; 
  }
  
  function clearGrid(){ 
    // ğŸ¯ ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼Œç•¶å‰æŒ‰éˆ•é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    setButtonStates('æ¸…é™¤è¡¨æ ¼', 'æ¸…é™¤ä¸­...');
    
    // æ¨¡æ“¬æ¸…é™¤å»¶é²ï¼ˆå¯é¸ï¼‰
    setTimeout(() => {
      document.getElementById('grid').innerHTML=''; 
      meta={students:[],dates:[],attendanceMap:{}}; 
      document.getElementById('msg').innerText='å·²æ¸…é™¤è¡¨æ ¼';
      
      resetButtonStates();
    }, 500);
  }
  
  function saveAll(){
    const group=document.getElementById('groupSel').value;
    const month=document.getElementById('monthSel').value;
    if(!group||!month){ 
      document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; 
      return; 
    }
    if(!meta.students.length||!meta.dates.length){ 
      document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; 
      return; 
    }
    const table=document.querySelector('#grid table'); 
    if(!table){ 
      document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; 
      return; 
    }

    // ğŸ¯ ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼Œç•¶å‰æŒ‰éˆ•é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    setButtonStates('å„²å­˜', 'å„²å­˜ä¸­...');

    console.log('=== é–‹å§‹å„²å­˜åˆ°å‡ºå¸­ç´€éŒ„å½™ç¸½ ===');
    console.log('çµ„åˆ¥:', group);
    console.log('æœˆä»½:', month);
    console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
    console.log('å­¸ç”Ÿæ•¸é‡:', meta.students.length);

    // ğŸ¯ çµ±ä¸€çš„æ—¥æœŸæ ¼å¼è½‰æ›å‡½æ•¸
    function convertToBackendDate(frontendDate) {
      let pureDate = frontendDate;
      
      // è™•ç†åŒ…å«å¹´ä»½çš„æƒ…æ³: "2025/10/1" -> "10/1"
      if (pureDate.includes('/') && pureDate.split('/').length === 3) {
        const parts = pureDate.split('/');
        pureDate = `${parts[1]}/${parts[2]}`;
      }
      
      // è™•ç†åŒ…å«æ˜ŸæœŸçš„æƒ…æ³: "10/1 (äºŒ)" -> "10/1"
      if (pureDate.includes('(')) {
        pureDate = pureDate.split(' ')[0];
      }
      
      return pureDate;
    }

    // ğŸ¯ æ–°æ ¼å¼ï¼šæº–å‚™æ›´æ–°è³‡æ–™ï¼ŒåŒ…å«å­¸ç”Ÿè³‡è¨Šå’Œå‡ºå¸­è¨˜éŒ„
    const updateData = {
      group: group,
      month: month,
      students: meta.students,  // å­¸ç”Ÿå®Œæ•´è³‡è¨Š
      dates: meta.dates.map(date => convertToBackendDate(date)),  // çµ±ä¸€çš„æ—¥æœŸæ ¼å¼
      attendanceGrid: []  // å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
    };

    console.log('è½‰æ›å¾Œçš„æ—¥æœŸæ ¼å¼:', updateData.dates);

    // å»ºç«‹å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
    table.querySelectorAll('tbody tr').forEach((tr, studentIndex) => {
      const studentId = meta.students[studentIndex].id;
      const selects = tr.querySelectorAll('select');
      
      console.log(`è™•ç†å­¸ç”Ÿ ${studentIndex + 1}: ${studentId}`);
      
      const attendanceRow = [];
      selects.forEach((sel, dateIndex) => { 
        const val = sel.value || ''; 
        
        // ğŸ¯ è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ï¼š0=è«‹å‡, 1=å‡ºå¸­, 2=è£œèª², ç©ºç™½=''
        let numericValue = '';
        if(val === 'è«‹å‡') numericValue = 0;
        else if(val === 'å‡ºå¸­') numericValue = 1;
        else if(val === 'è£œèª²') numericValue = 2;
        
        attendanceRow.push(numericValue);
        
        if(val !== '') {
          const fullDate = meta.dates[dateIndex];
          const pureDate = convertToBackendDate(fullDate);
          console.log(`  è¨˜éŒ„ ${dateIndex + 1}: ${studentId} ${fullDate} -> ${pureDate} = ${val} (${numericValue})`);
        }
      });
      
      updateData.attendanceGrid.push(attendanceRow);
    });

    console.log('æº–å‚™æ›´æ–°çš„ç¶²æ ¼è³‡æ–™:', updateData);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‡ºå¸­è¨˜éŒ„
    const hasAnyRecord = updateData.attendanceGrid.some(row => 
      row.some(cell => cell !== '')
    );
    
    if(!hasAnyRecord) { 
      console.warn('æ²’æœ‰ä»»ä½•è¨˜éŒ„è¦å„²å­˜');
      document.getElementById('msg').innerText = 'æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; 
      
      resetButtonStates();
      return; 
    }
    
    document.getElementById('msg').innerText = 'æ­£åœ¨æ›´æ–°å‡ºå¸­ç´€éŒ„å½™ç¸½...';

    // ğŸ¯ å‘¼å«å¾Œç«¯å‡½æ•¸ï¼šç›´æ¥æ›´æ–°å·¥ä½œè¡¨
    google.script.run
      .withSuccessHandler(res => {
        console.log('âœ… æ›´æ–°æˆåŠŸå›æ‡‰:', res);
        document.getElementById('msg').innerText = res.message || 'æ›´æ–°å®Œæˆ';
        
        // ğŸ¯ ä¿®æ”¹ï¼šä¸ç«‹å³æ¢å¾©æŒ‰éˆ•ï¼Œæ”¹ç‚ºæ›´æ–°æŒ‰éˆ•ç‹€æ…‹ç‚ºé‡æ–°è¼‰å…¥
        updateButtonText('å„²å­˜ä¸­...', 'é‡æ–°è¼‰å…¥ä¸­...');
        
        // ğŸ¯ é‡è¦ï¼šç¢ºä¿æ‰€æœ‰æŒ‰éˆ•ä¿æŒç¦ç”¨ç‹€æ…‹
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
          if (btn.textContent !== 'é‡æ–°è¼‰å…¥ä¸­...') {
            btn.disabled = true;
            btn.style.opacity = '0.4';
            btn.style.cursor = 'not-allowed';
            btn.style.backgroundColor = '#f5f5f5';
            btn.style.color = '#999';
          }
        });
        
        // å„²å­˜æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„ï¼ˆä¿æŒæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹ï¼‰
        setTimeout(() => {
          document.getElementById('msg').innerText = 'æ­£åœ¨é‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„...';
          loadExistingAttendanceAfterSave();
        }, 1000);
      })
      .withFailureHandler(error => {
        console.error('âŒ æ›´æ–°å¤±æ•—:', error);
        document.getElementById('msg').innerText = 'æ›´æ–°å¤±æ•—: ' + error.message;
        
        resetButtonStates();
        setButtonError('saveAll');
      })
      .updateAttendanceSummary_optimized(updateData);
    
    console.log('=== æ›´æ–°è«‹æ±‚å·²ç™¼é€ ===');
  }

  // ğŸ¯ ä¿®æ”¹ï¼šå„²å­˜å¾Œé‡æ–°è¼‰å…¥è¨˜éŒ„ï¼ˆä¿æŒæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹ï¼‰
  function loadExistingAttendanceAfterSave(){
    const group = document.getElementById('groupSel').value;
    const month = document.getElementById('monthSel').value;
    
    google.script.run
      .withSuccessHandler(records => {
        console.log('é‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„:', records);
        
        if(!records || records.length === 0) {
          document.getElementById('msg').innerText = 
            `æ›´æ–°å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œç„¡æ—¢æœ‰è¨˜éŒ„`;
          
          resetButtonStates();
          return;
        }
        
        let loadedCount = 0;
        
        // æ¸…é™¤ä¹‹å‰çš„èƒŒæ™¯è‰²
        document.querySelectorAll('select').forEach(sel => {
          sel.style.backgroundColor = '';
        });
        
        records.forEach(record => {
          // æ—¥æœŸæ ¼å¼è½‰æ›é‚è¼¯ï¼ˆåŒä¸Šï¼‰
          let targetDate = record.date;
          const matchedDate = meta.dates.find(frontendDate => {
            let frontendDateOnly = frontendDate;
            if (frontendDateOnly.includes('/') && frontendDateOnly.split('/').length === 3) {
              const parts = frontendDateOnly.split('/');
              frontendDateOnly = `${parts[1]}/${parts[2]}`;
            }
            if (frontendDateOnly.includes('(')) {
              frontendDateOnly = frontendDateOnly.split(' ')[0];
            }
            return frontendDateOnly === record.date;
          });
          
          if(matchedDate) {
            targetDate = matchedDate;
          }
          
          const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
          const sel = document.querySelector(selector);
          
          if(sel) {
            sel.value = record.status;
            sel.style.backgroundColor = '#ffffcc';
            loadedCount++;
          }
        });
        
        document.getElementById('msg').innerText = 
          `æ›´æ–°å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œ${loadedCount} ç­†æ—¢æœ‰è¨˜éŒ„`;
        
        resetButtonStates();
      })
      .withFailureHandler(error => {
        console.error('é‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('msg').innerText = 'æ›´æ–°å®Œæˆï¼Œä½†é‡æ–°è¼‰å…¥è¨˜éŒ„å¤±æ•—';
        
        resetButtonStates();
        setButtonError('saveAll');
      })
      .getExistingAttendance(group, month);
  }
  
  window.onload=init;
</script>

</body>
</html>