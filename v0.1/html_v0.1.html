<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    body {
      font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”";
      margin: 10px;
      font-size: 13px;
    }
    .row {
      margin-bottom: 8px;
    }
    label {
      display: inline-block;
      width: 70px;
    }
    select, button {
      padding: 6px;
      font-size: 13px;
    }
    #gridWrap {
      overflow: auto;
      max-height: 500px;
      border: 1px solid #ddd;
      padding: 8px;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 80px;
      text-align: center;
    }
    th.date {
      background: #f6f6f6;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .loading-btn {
      position: relative;
      overflow: hidden;
    }
    
    .loading-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: loading-sweep 1.5s infinite;
    }
    
    @keyframes loading-sweep {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .btn-error {
      background-color: #ffebee !important;
      animation: btn-error-shake 0.5s ease-in-out;
    }
    
    @keyframes btn-error-shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
</style>
</head>
<body>
<h3>å»£é’é›²ç«¯å…¨å»£å¤§èª²é»åç³»çµ±ï¼ˆWebï¼‰</h3>

<div class="row">
<label>çµ„åˆ¥</label>
<select id="groupSel"></select>
</div>

<div class="row">
<label>æœˆä»½</label>
<select id="monthSel"></select>
</div>

<div class="row">
<button onclick="loadGrid()">ç”¢ç”Ÿäº’å‹•è¡¨æ ¼</button>
<button onclick="saveAll()">å„²å­˜</button>
<button onclick="clearGrid()">æ¸…é™¤è¡¨æ ¼</button>
</div>


<div id="gridWrap"><div id="grid"></div></div>
<div id="msg" class="small"></div>

<script>
let meta={students:[],dates:[],attendanceMap:{}};

function init(){
  google.script.run.withSuccessHandler(popGroups).getGroups();
  google.script.run.withSuccessHandler(popMonths).getMonths();
  document.getElementById('msg').innerText='è«‹é¸çµ„åˆ¥èˆ‡æœˆä»½';
}

function popGroups(groups){
  const sel=document.getElementById('groupSel');
  sel.innerHTML='<option value="">(è«‹é¸çµ„åˆ¥)</option>';
  groups.forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.text=g; sel.appendChild(opt); });
}

function popMonths(months){
  const sel=document.getElementById('monthSel');
  sel.innerHTML='<option value="">(è«‹é¸æœˆä»½)</option>';
  months.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.text=m; sel.appendChild(opt); });
}
/*
function loadGrid(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  document.getElementById('msg').innerText='è¼‰å…¥ä¸­...';
  meta.students=[]; meta.dates=[];

  google.script.run.withSuccessHandler(students=>{
    meta.students=students; if(meta.dates.length) buildGrid();
  }).getStudentsByGroup('A01');

  google.script.run.withSuccessHandler(dates=>{
    meta.dates=dates; if(meta.students.length) buildGrid();
  }).getDatesByMonth('10');
}
*/

function loadGrid(){
    const group=document.getElementById('groupSel').value;
    const month=document.getElementById('monthSel').value;
    if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
    document.getElementById('msg').innerText='è¼‰å…¥ä¸­...';
    meta.students=[]; meta.dates=[];

    // å‘¼å«1: è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    google.script.run
      .withSuccessHandler(students=>{
        console.log('æˆåŠŸè¼‰å…¥å­¸ç”Ÿè³‡æ–™:', students);
        meta.students=students; 
        //meta.students = [
        //    {id: "S001", name: "å¼µä¸‰", email: "zhang@example.com"},
        //    {id: "S002", name: "æå››", email: "lee@example.com"}
        //];
        if(meta.dates.length) buildGrid(); // ç­‰å¾…æ—¥æœŸè³‡æ–™
      })
      .withFailureHandler(error=>{
        console.error('è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:', error);
        document.getElementById('msg').innerText='è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—: ' + error.message;
      })
      .getStudentsByGroup(group);
    
    // å‘¼å«2: è¼‰å…¥æ—¥æœŸè³‡æ–™  
    google.script.run
      .withSuccessHandler(dates=>{
        console.log('æˆåŠŸè¼‰å…¥æ—¥æœŸè³‡æ–™:', dates);
        meta.dates=dates; 
        // meta.dates: ["10/03", "10/10", "10/17", "10/24", "10/31"]
        if(meta.students.length) buildGrid(); // ç­‰å¾…å­¸ç”Ÿè³‡æ–™
      })
      .withFailureHandler(error=>{
        console.error('è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—:', error);
        document.getElementById('msg').innerText='è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—: ' + error.message;
      })
      .getDatesByMonth(month);
}


function buildGrid(){
  const container = document.getElementById('grid');
  container.innerHTML = '';
  
  // æª¢æŸ¥å­¸ç”Ÿè³‡æ–™
  if(!meta.students.length){ 
    container.innerHTML = '<div class="small">æ­¤çµ„ç„¡å­¸ç”Ÿ</div>'; 
    document.getElementById('msg').innerText = 'æ­¤çµ„ç„¡å­¸ç”Ÿè³‡æ–™';
    return; 
  }

  // æª¢æŸ¥æ—¥æœŸè³‡æ–™
  if(!meta.dates.length){ 
    container.innerHTML = '<div class="small">æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥</div>'; 
    document.getElementById('msg').innerText = 'æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥æœŸ';
    return; 
  }

  const table = document.createElement('table');
  
  // å»ºç«‹è¡¨é ­
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  hr.appendChild(tdEl('å­¸ç±ç·¨è™Ÿ', 'th'));
  hr.appendChild(tdEl('å§“å', 'th'));
  meta.dates.forEach(d => hr.appendChild(tdEl(d, 'th', 'date')));
  thead.appendChild(hr);
  table.appendChild(thead);

  // å»ºç«‹è¡¨èº«
  const tbody = document.createElement('tbody');
  meta.students.forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.appendChild(tdEl(s.id));
    tr.appendChild(tdEl(s.name));
    
    meta.dates.forEach(dt => {
      const td = document.createElement('td');
      const sel = document.createElement('select');
      sel.setAttribute('data-student', s.id);
      sel.setAttribute('data-date', dt);
      
      ['', 'è«‹å‡', 'å‡ºå¸­', 'è£œèª²'].forEach(opt => { 
        const o = document.createElement('option'); 
        o.value = opt; 
        o.text = (opt === '' ? 'â€”' : opt); 
        sel.appendChild(o); 
      });
      
      td.appendChild(sel);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  
  table.appendChild(tbody);
  container.appendChild(table);
  
  // å»ºç«‹è¡¨æ ¼å¾Œï¼Œè¼‰å…¥æ—¢æœ‰çš„å‡ºå¸­è¨˜éŒ„
  loadExistingAttendance();
  
  document.getElementById('msg').innerText = `è¼‰å…¥ä¸­ï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥`;
}


// æ–°å¢å‡½æ•¸ï¼šè¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„ (å¢å¼·ç‰ˆ)
// ä¿®æ­£ç‰ˆï¼šè¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„ (è™•ç†æ—¥æœŸæ ¼å¼å·®ç•°)
function loadExistingAttendance(){
  const group = document.getElementById('groupSel').value;
  const month = document.getElementById('monthSel').value;
  
  console.log(`é–‹å§‹è¼‰å…¥æ—¢æœ‰è¨˜éŒ„: çµ„åˆ¥=${group}, æœˆä»½=${month}`);
  console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
  
  // æš«æ™‚ç¦ç”¨å„²å­˜æŒ‰éˆ•
  const saveBtn = document.querySelector('button[onclick="saveAll()"]');
  if(saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'è¼‰å…¥ä¸­...';
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  document.getElementById('msg').innerText = 'æ­£åœ¨è¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„...';
  
  google.script.run
    .withSuccessHandler(records => {
      console.log('æˆåŠŸè¼‰å…¥æ—¢æœ‰è¨˜éŒ„:', records);
      console.log('è¨˜éŒ„æ•¸é‡:', records.length);
      
      if(!records || records.length === 0) {
        console.log('æ²’æœ‰æ‰¾åˆ°æ—¢æœ‰è¨˜éŒ„');
        // æ¢å¾©å„²å­˜æŒ‰éˆ•
        if(saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'å„²å­˜';
        }
        document.getElementById('msg').innerText = 
          `è¼‰å…¥ä¸­ï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œç„¡æ—¢æœ‰è¨˜éŒ„`;
        return;
      }
      
      let loadedCount = 0;
      let notFoundCount = 0;
      
      records.forEach(record => {
        console.log(`è™•ç†è¨˜éŒ„: ${record.studentId} ${record.date} = ${record.status}`);
        
        // ğŸ¯ é—œéµä¿®æ­£ï¼šè½‰æ›å¾Œç«¯æ—¥æœŸæ ¼å¼ç‚ºå‰ç«¯æ ¼å¼
        let targetDate = record.date;
        
        // å¦‚æœå¾Œç«¯æ—¥æœŸæ²’æœ‰æ˜ŸæœŸï¼Œå˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å‰ç«¯æ—¥æœŸ
        if(!targetDate.includes('(')) {
          const matchedDate = meta.dates.find(frontendDate => {
            const frontendDateOnly = frontendDate.split(' ')[0]; // "10/01 (ä¸‰)" -> "10/01"
            return frontendDateOnly === record.date;
          });
          
          if(matchedDate) {
            targetDate = matchedDate;
            console.log(`ğŸ”„ æ—¥æœŸæ ¼å¼è½‰æ›: ${record.date} -> ${targetDate}`);
          }
        }
        
        const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
        const sel = document.querySelector(selector);
        
        if(sel) {
          sel.value = record.status;
          sel.style.backgroundColor = '#ffffcc'; // æ¨™ç¤ºå·²è¼‰å…¥çš„è¨˜éŒ„
          loadedCount++;
          console.log(`âœ“ æˆåŠŸè¨­å®š: ${record.studentId} ${targetDate} = ${record.status}`);
        } else {
          notFoundCount++;
          console.warn(`âœ— æ‰¾ä¸åˆ°å°æ‡‰çš„é¸æ“‡æ¡†: ${record.studentId} ${targetDate}`);
          console.warn(`ä½¿ç”¨çš„é¸æ“‡å™¨: ${selector}`);
          console.warn(`åŸå§‹æ—¥æœŸ: ${record.date}, è½‰æ›å¾Œæ—¥æœŸ: ${targetDate}`);
        }
      });
      
      console.log(`è¼‰å…¥çµæœ: æˆåŠŸ ${loadedCount} ç­†, æ‰¾ä¸åˆ° ${notFoundCount} ç­†`);
      
      // æ¢å¾©å„²å­˜æŒ‰éˆ•
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜';
      }
      
      // é¡¯ç¤ºçµæœ
      let message = `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œ${loadedCount} ç­†æ—¢æœ‰è¨˜éŒ„`;
      if(notFoundCount > 0) {
        message += `ï¼Œ${notFoundCount} ç­†è¨˜éŒ„ç„¡æ³•å°æ‡‰`;
      }
      document.getElementById('msg').innerText = message;
    })
    .withFailureHandler(error => {
      console.error('è¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—:', error);
      
      // æ¢å¾©å„²å­˜æŒ‰éˆ•
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜';
      }
      
      document.getElementById('msg').innerText = 
        `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼ˆè¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—: ${error.message})`;
    })
    .getExistingAttendance(group, month);
}


function tdEl(txt, tag, className){ 
  const el = document.createElement(tag || 'td'); 
  el.innerText = txt; 
  if(className) el.className = className;
  return el; 
}

function clearGrid(){ document.getElementById('grid').innerHTML=''; meta={students:[],dates:[],attendanceMap:{}}; document.getElementById('msg').innerText='å·²æ¸…é™¤è¡¨æ ¼'; }

function saveAll_v0_1(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  if(!meta.students.length||!meta.dates.length){ document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; return; }
  const table=document.querySelector('#grid table'); if(!table){ document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; return; }

  const records=[];
  table.querySelectorAll('tbody tr').forEach((tr,i)=>{
    const sid=meta.students[i].id;
    const selects=tr.querySelectorAll('select');
    selects.forEach((sel,j)=>{ 
      const val=sel.value||''; 
      if(val!=='') {
        // ğŸ¯ é—œéµä¿®æ­£ï¼šå»é™¤æ—¥æœŸä¸­çš„æ˜ŸæœŸè³‡è¨Š
        const fullDate = meta.dates[j];                    // "10/03 (å››)"
        const pureDate = fullDate.split(' ')[0];          // "10/03"
        
        records.push({
          studentId: sid,
          date: pureDate,  // åªä¿ç•™ç´”æ—¥æœŸéƒ¨åˆ†
          status: val
        }); 
      }
    });
  });

  if(records.length===0){ document.getElementById('msg').innerText='æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; return; }
  
  console.log('æº–å‚™å„²å­˜çš„è¨˜éŒ„:', records); // é™¤éŒ¯ç”¨
  document.getElementById('msg').innerText='å„²å­˜ä¸­...';

  google.script.run
    .withSuccessHandler(res=>{
      console.log('å„²å­˜æˆåŠŸå›æ‡‰:', res); // é™¤éŒ¯ç”¨
      document.getElementById('msg').innerText=res.message||'å„²å­˜å®Œæˆ';
    })
    .withFailureHandler(error=>{
      console.error('å„²å­˜å¤±æ•—:', error); // é™¤éŒ¯ç”¨
      document.getElementById('msg').innerText='å„²å­˜å¤±æ•—: ' + error.message;
    })
    .saveAttendance_v2({group:group,month:month,records:records});
}


function saveAll_0_1_2(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  if(!meta.students.length||!meta.dates.length){ document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; return; }
  const table=document.querySelector('#grid table'); if(!table){ document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; return; }

  console.log('=== é–‹å§‹å„²å­˜åˆ°å‡ºå¸­ç´€éŒ„å½™ç¸½ ===');
  console.log('çµ„åˆ¥:', group);
  console.log('æœˆä»½:', month);
  console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
  console.log('å­¸ç”Ÿæ•¸é‡:', meta.students.length);

  // ğŸ¯ æ–°æ ¼å¼ï¼šæº–å‚™æ›´æ–°è³‡æ–™ï¼ŒåŒ…å«å­¸ç”Ÿè³‡è¨Šå’Œå‡ºå¸­è¨˜éŒ„
  const updateData = {
    group: group,
    month: month,
    students: meta.students,  // å­¸ç”Ÿå®Œæ•´è³‡è¨Š
    dates: meta.dates.map(date => date.split(' ')[0]),  // ç´”æ—¥æœŸæ ¼å¼
    attendanceGrid: []  // å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  };

  // å»ºç«‹å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  table.querySelectorAll('tbody tr').forEach((tr, studentIndex) => {
    const studentId = meta.students[studentIndex].id;
    const selects = tr.querySelectorAll('select');
    
    console.log(`è™•ç†å­¸ç”Ÿ ${studentIndex + 1}: ${studentId}`);
    
    const attendanceRow = [];
    selects.forEach((sel, dateIndex) => { 
      const val = sel.value || ''; 
      
      // ğŸ¯ è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ï¼š0=è«‹å‡, 1=å‡ºå¸­, 2=è£œèª², ç©ºç™½=''
      let numericValue = '';
      if(val === 'è«‹å‡') numericValue = 0;
      else if(val === 'å‡ºå¸­') numericValue = 1;
      else if(val === 'è£œèª²') numericValue = 2;
      
      attendanceRow.push(numericValue);
      
      if(val !== '') {
        const fullDate = meta.dates[dateIndex];
        const pureDate = fullDate.split(' ')[0];
        console.log(`  è¨˜éŒ„ ${dateIndex + 1}: ${studentId} ${fullDate} -> ${pureDate} = ${val} (${numericValue})`);
      }
    });
    
    updateData.attendanceGrid.push(attendanceRow);
  });

  console.log('æº–å‚™æ›´æ–°çš„ç¶²æ ¼è³‡æ–™:', updateData);
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‡ºå¸­è¨˜éŒ„
  const hasAnyRecord = updateData.attendanceGrid.some(row => 
    row.some(cell => cell !== '')
  );
  
  if(!hasAnyRecord) { 
    console.warn('æ²’æœ‰ä»»ä½•è¨˜éŒ„è¦å„²å­˜');
    document.getElementById('msg').innerText = 'æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; 
    return; 
  }
  
  document.getElementById('msg').innerText = 'æ­£åœ¨æ›´æ–°å‡ºå¸­ç´€éŒ„å½™ç¸½...';

  // ğŸ¯ å‘¼å«æ–°çš„å¾Œç«¯å‡½æ•¸ï¼šç›´æ¥æ›´æ–°å·¥ä½œè¡¨
  google.script.run
    .withSuccessHandler(res => {
      console.log('âœ… æ›´æ–°æˆåŠŸå›æ‡‰:', res);
      document.getElementById('msg').innerText = res.message || 'æ›´æ–°å®Œæˆ';
      
      // å„²å­˜æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„
      setTimeout(() => {
        loadExistingAttendance();
      }, 1000);
    })
    .withFailureHandler(error => {
      console.error('âŒ æ›´æ–°å¤±æ•—:', error);
      document.getElementById('msg').innerText = 'æ›´æ–°å¤±æ•—: ' + error.message;
    })
    //.updateAttendanceSummary(updateData);  // æ–°çš„å¾Œç«¯å‡½æ•¸
    .updateAttendanceSummary_optimized(updateData);  // ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬
  
  console.log('=== æ›´æ–°è«‹æ±‚å·²ç™¼é€ ===');
}

function saveAll(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  if(!meta.students.length||!meta.dates.length){ document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; return; }
  const table=document.querySelector('#grid table'); if(!table){ document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; return; }

  // ğŸ¯ 1. ç¦ç”¨å„²å­˜æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
  const saveBtn = document.querySelector('button[onclick="saveAll()"]');
  const originalText = saveBtn ? saveBtn.textContent : 'å„²å­˜';
  
  if(saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'å„²å­˜ä¸­...';
    saveBtn.style.opacity = '0.6';
    saveBtn.style.cursor = 'not-allowed';
  }

  console.log('=== é–‹å§‹å„²å­˜åˆ°å‡ºå¸­ç´€éŒ„å½™ç¸½ ===');
  console.log('çµ„åˆ¥:', group);
  console.log('æœˆä»½:', month);
  console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
  console.log('å­¸ç”Ÿæ•¸é‡:', meta.students.length);

  // ğŸ¯ çµ±ä¸€çš„æ—¥æœŸæ ¼å¼è½‰æ›å‡½æ•¸
  function convertToBackendDate(frontendDate) {
    let pureDate = frontendDate;
    
    // è™•ç†åŒ…å«å¹´ä»½çš„æƒ…æ³: "2025/10/1" -> "10/1"
    if (pureDate.includes('/') && pureDate.split('/').length === 3) {
      const parts = pureDate.split('/');
      pureDate = `${parts[1]}/${parts[2]}`;
    }
    
    // è™•ç†åŒ…å«æ˜ŸæœŸçš„æƒ…æ³: "10/1 (äºŒ)" -> "10/1"
    if (pureDate.includes('(')) {
      pureDate = pureDate.split(' ')[0];
    }
    
    return pureDate;
  }

  // ğŸ¯ æ–°æ ¼å¼ï¼šæº–å‚™æ›´æ–°è³‡æ–™ï¼ŒåŒ…å«å­¸ç”Ÿè³‡è¨Šå’Œå‡ºå¸­è¨˜éŒ„
  const updateData = {
    group: group,
    month: month,
    students: meta.students,  // å­¸ç”Ÿå®Œæ•´è³‡è¨Š
    dates: meta.dates.map(date => convertToBackendDate(date)),  // çµ±ä¸€çš„æ—¥æœŸæ ¼å¼
    attendanceGrid: []  // å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  };

  console.log('è½‰æ›å¾Œçš„æ—¥æœŸæ ¼å¼:', updateData.dates);

  // å»ºç«‹å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  table.querySelectorAll('tbody tr').forEach((tr, studentIndex) => {
    const studentId = meta.students[studentIndex].id;
    const selects = tr.querySelectorAll('select');
    
    console.log(`è™•ç†å­¸ç”Ÿ ${studentIndex + 1}: ${studentId}`);
    
    const attendanceRow = [];
    selects.forEach((sel, dateIndex) => { 
      const val = sel.value || ''; 
      
      // ğŸ¯ è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ï¼š0=è«‹å‡, 1=å‡ºå¸­, 2=è£œèª², ç©ºç™½=''
      let numericValue = '';
      if(val === 'è«‹å‡') numericValue = 0;
      else if(val === 'å‡ºå¸­') numericValue = 1;
      else if(val === 'è£œèª²') numericValue = 2;
      
      attendanceRow.push(numericValue);
      
      if(val !== '') {
        const fullDate = meta.dates[dateIndex];
        const pureDate = convertToBackendDate(fullDate);
        console.log(`  è¨˜éŒ„ ${dateIndex + 1}: ${studentId} ${fullDate} -> ${pureDate} = ${val} (${numericValue})`);
      }
    });
    
    updateData.attendanceGrid.push(attendanceRow);
  });

  console.log('æº–å‚™æ›´æ–°çš„ç¶²æ ¼è³‡æ–™:', updateData);
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‡ºå¸­è¨˜éŒ„
  const hasAnyRecord = updateData.attendanceGrid.some(row => 
    row.some(cell => cell !== '')
  );
  
  if(!hasAnyRecord) { 
    console.warn('æ²’æœ‰ä»»ä½•è¨˜éŒ„è¦å„²å­˜');
    
    // ğŸ¯ 2. æ¢å¾©å„²å­˜æŒ‰éˆ•
    if(saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
      saveBtn.style.opacity = '1';
      saveBtn.style.cursor = 'pointer';
    }
    
    document.getElementById('msg').innerText = 'æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; 
    return; 
  }
  
  document.getElementById('msg').innerText = 'æ­£åœ¨æ›´æ–°å‡ºå¸­ç´€éŒ„å½™ç¸½...';

  // ğŸ¯ å‘¼å«å¾Œç«¯å‡½æ•¸ï¼šç›´æ¥æ›´æ–°å·¥ä½œè¡¨
  google.script.run
    .withSuccessHandler(res => {
      console.log('âœ… æ›´æ–°æˆåŠŸå›æ‡‰:', res);
      document.getElementById('msg').innerText = res.message || 'æ›´æ–°å®Œæˆ';
      
      // ğŸ¯ 3. æ¢å¾©å„²å­˜æŒ‰éˆ• (æˆåŠŸ)
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
      }
      
      // å„²å­˜æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„
      setTimeout(() => {
        loadExistingAttendance();
      }, 1000);
    })
    .withFailureHandler(error => {
      console.error('âŒ æ›´æ–°å¤±æ•—:', error);
      document.getElementById('msg').innerText = 'æ›´æ–°å¤±æ•—: ' + error.message;
      
      // ğŸ¯ 4. æ¢å¾©å„²å­˜æŒ‰éˆ• (å¤±æ•—)
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
        saveBtn.style.backgroundColor = '#ffebee'; // æ·ºç´…è‰²è¡¨ç¤ºéŒ¯èª¤
        
        // 3ç§’å¾Œæ¸…é™¤éŒ¯èª¤æ¨£å¼
        setTimeout(() => {
          if(saveBtn) {
            saveBtn.style.backgroundColor = '';
          }
        }, 3000);
      }
    })
    .updateAttendanceSummary_optimized(updateData);  // ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬
  
  console.log('=== æ›´æ–°è«‹æ±‚å·²ç™¼é€ ===');
}

window.onload=init;
</script>
</body>
</html>
