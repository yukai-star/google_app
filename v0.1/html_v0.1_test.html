<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    body {
      font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”";
      margin: 10px;
      font-size: 13px;
    }
    .row {
      margin-bottom: 8px;
    }
    label {
      display: inline-block;
      width: 70px;
    }
    select, button {
      padding: 6px;
      font-size: 13px;
    }
    #gridWrap {
      overflow: auto;
      max-height: 500px;
      border: 1px solid #ddd;
      padding: 8px;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      min-width: 80px;
      text-align: center;
    }
    th.date {
      background: #f6f6f6;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
</style>
</head>
<body>
<h3>å»£é’é›²ç«¯å…¨å»£å¤§èª²é»åç³»çµ±ï¼ˆWebï¼‰</h3>

<div class="row">
<label>çµ„åˆ¥</label>
<select id="groupSel"></select>
</div>

<div class="row">
<label>æœˆä»½</label>
<select id="monthSel"></select>
</div>

<div class="row">
<button onclick="loadGrid()">ç”¢ç”Ÿäº’å‹•è¡¨æ ¼</button>
<button onclick="saveAll()">å„²å­˜</button>
<button onclick="clearGrid()">æ¸…é™¤è¡¨æ ¼</button>
<button onclick="testSelector()" style="background-color: #ff9800; color: white;">ğŸ§ª æ¸¬è©¦é¸æ“‡å™¨</button>
</div>

<div class="row">
<button onclick="testSuggestions()" style="background-color: #4CAF50; color: white;">ğŸ¯ åŸ·è¡Œæ¸¬è©¦å»ºè­°</button>
<button onclick="testDateCompatibility()" style="background-color: #2196F3; color: white;">ğŸ“… æ¸¬è©¦æ—¥æœŸç›¸å®¹æ€§</button>
<button onclick="testMockBackendData()" style="background-color: #9C27B0; color: white;">ğŸ“Š æ¸¬è©¦æ¨¡æ“¬è³‡æ–™</button>
</div>

<div id="gridWrap"><div id="grid"></div></div>
<div id="msg" class="small"></div>

<script>
let meta={students:[],dates:[],attendanceMap:{}};

function init(){
  google.script.run.withSuccessHandler(popGroups).getGroups();
  google.script.run.withSuccessHandler(popMonths).getMonths();
  document.getElementById('msg').innerText='è«‹é¸çµ„åˆ¥èˆ‡æœˆä»½';
}

function popGroups(groups){
  const sel=document.getElementById('groupSel');
  sel.innerHTML='<option value="">(è«‹é¸çµ„åˆ¥)</option>';
  groups.forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.text=g; sel.appendChild(opt); });
}

function popMonths(months){
  const sel=document.getElementById('monthSel');
  sel.innerHTML='<option value="">(è«‹é¸æœˆä»½)</option>';
  months.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.text=m; sel.appendChild(opt); });
}
/*
function loadGrid(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  document.getElementById('msg').innerText='è¼‰å…¥ä¸­...';
  meta.students=[]; meta.dates=[];

  google.script.run.withSuccessHandler(students=>{
    meta.students=students; if(meta.dates.length) buildGrid();
  }).getStudentsByGroup('A01');

  google.script.run.withSuccessHandler(dates=>{
    meta.dates=dates; if(meta.students.length) buildGrid();
  }).getDatesByMonth('10');
}
*/

function loadGrid(){
    const group=document.getElementById('groupSel').value;
    const month=document.getElementById('monthSel').value;
    if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
    document.getElementById('msg').innerText='è¼‰å…¥ä¸­...';
    meta.students=[]; meta.dates=[];

    // å‘¼å«1: è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    google.script.run
      .withSuccessHandler(students=>{
        console.log('æˆåŠŸè¼‰å…¥å­¸ç”Ÿè³‡æ–™:', students);
        meta.students=students; 
        //meta.students = [
        //    {id: "S001", name: "å¼µä¸‰", email: "zhang@example.com"},
        //    {id: "S002", name: "æå››", email: "lee@example.com"}
        //];
        if(meta.dates.length) buildGrid(); // ç­‰å¾…æ—¥æœŸè³‡æ–™
      })
      .withFailureHandler(error=>{
        console.error('è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:', error);
        document.getElementById('msg').innerText='è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—: ' + error.message;
      })
      .getStudentsByGroup(group);
    
    // å‘¼å«2: è¼‰å…¥æ—¥æœŸè³‡æ–™  
    google.script.run
      .withSuccessHandler(dates=>{
        console.log('æˆåŠŸè¼‰å…¥æ—¥æœŸè³‡æ–™:', dates);
        meta.dates=dates; 
        // meta.dates: ["10/03", "10/10", "10/17", "10/24", "10/31"]
        if(meta.students.length) buildGrid(); // ç­‰å¾…å­¸ç”Ÿè³‡æ–™
      })
      .withFailureHandler(error=>{
        console.error('è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—:', error);
        document.getElementById('msg').innerText='è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—: ' + error.message;
      })
      .getDatesByMonth(month);
}


function buildGrid(){
  const container = document.getElementById('grid');
  container.innerHTML = '';
  
  // æª¢æŸ¥å­¸ç”Ÿè³‡æ–™
  if(!meta.students.length){ 
    container.innerHTML = '<div class="small">æ­¤çµ„ç„¡å­¸ç”Ÿ</div>'; 
    document.getElementById('msg').innerText = 'æ­¤çµ„ç„¡å­¸ç”Ÿè³‡æ–™';
    return; 
  }

  // æª¢æŸ¥æ—¥æœŸè³‡æ–™
  if(!meta.dates.length){ 
    container.innerHTML = '<div class="small">æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥</div>'; 
    document.getElementById('msg').innerText = 'æ­¤æœˆä»½ç„¡ä¸Šèª²æ—¥æœŸ';
    return; 
  }

  const table = document.createElement('table');
  
  // å»ºç«‹è¡¨é ­
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  hr.appendChild(tdEl('å­¸ç±ç·¨è™Ÿ', 'th'));
  hr.appendChild(tdEl('å§“å', 'th'));
  meta.dates.forEach(d => hr.appendChild(tdEl(d, 'th', 'date')));
  thead.appendChild(hr);
  table.appendChild(thead);

  // å»ºç«‹è¡¨èº«
  const tbody = document.createElement('tbody');
  meta.students.forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.appendChild(tdEl(s.id));
    tr.appendChild(tdEl(s.name));
    
    meta.dates.forEach(dt => {
      const td = document.createElement('td');
      const sel = document.createElement('select');
      sel.setAttribute('data-student', s.id);
      sel.setAttribute('data-date', dt);
      
      ['', 'è«‹å‡', 'å‡ºå¸­', 'è£œèª²'].forEach(opt => { 
        const o = document.createElement('option'); 
        o.value = opt; 
        o.text = (opt === '' ? 'â€”' : opt); 
        sel.appendChild(o); 
      });
      
      td.appendChild(sel);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  
  table.appendChild(tbody);
  container.appendChild(table);
  
  // å»ºç«‹è¡¨æ ¼å¾Œï¼Œè¼‰å…¥æ—¢æœ‰çš„å‡ºå¸­è¨˜éŒ„
  loadExistingAttendance();
  
  document.getElementById('msg').innerText = `è¼‰å…¥ä¸­ï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥`;
}


// æ–°å¢å‡½æ•¸ï¼šè¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„ (å¢å¼·ç‰ˆ)
// ä¿®æ­£ç‰ˆï¼šè¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„ (è™•ç†æ—¥æœŸæ ¼å¼å·®ç•°)
function loadExistingAttendance(){
  const group = document.getElementById('groupSel').value;
  const month = document.getElementById('monthSel').value;
  
  console.log(`é–‹å§‹è¼‰å…¥æ—¢æœ‰è¨˜éŒ„: çµ„åˆ¥=${group}, æœˆä»½=${month}`);
  console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
  
  // æš«æ™‚ç¦ç”¨å„²å­˜æŒ‰éˆ•
  const saveBtn = document.querySelector('button[onclick="saveAll()"]');
  if(saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = 'è¼‰å…¥ä¸­...';
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  document.getElementById('msg').innerText = 'æ­£åœ¨è¼‰å…¥æ—¢æœ‰å‡ºå¸­è¨˜éŒ„...';
  
  google.script.run
    .withSuccessHandler(records => {
      console.log('æˆåŠŸè¼‰å…¥æ—¢æœ‰è¨˜éŒ„:', records);
      console.log('è¨˜éŒ„æ•¸é‡:', records.length);
      
      if(!records || records.length === 0) {
        console.log('æ²’æœ‰æ‰¾åˆ°æ—¢æœ‰è¨˜éŒ„');
        // æ¢å¾©å„²å­˜æŒ‰éˆ•
        if(saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'å„²å­˜';
        }
        document.getElementById('msg').innerText = 
          `è¼‰å…¥ä¸­ï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œç„¡æ—¢æœ‰è¨˜éŒ„`;
        return;
      }
      
      let loadedCount = 0;
      let notFoundCount = 0;
      
      records.forEach(record => {
        console.log(`è™•ç†è¨˜éŒ„: ${record.studentId} ${record.date} = ${record.status}`);
        
        // ğŸ¯ é—œéµä¿®æ­£ï¼šè½‰æ›å¾Œç«¯æ—¥æœŸæ ¼å¼ç‚ºå‰ç«¯æ ¼å¼
        let targetDate = record.date;
        
        // å¦‚æœå¾Œç«¯æ—¥æœŸæ²’æœ‰æ˜ŸæœŸï¼Œå˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å‰ç«¯æ—¥æœŸ
        if(!targetDate.includes('(')) {
          const matchedDate = meta.dates.find(frontendDate => {
            const frontendDateOnly = frontendDate.split(' ')[0]; // "10/01 (ä¸‰)" -> "10/01"
            return frontendDateOnly === record.date;
          });
          
          if(matchedDate) {
            targetDate = matchedDate;
            console.log(`ğŸ”„ æ—¥æœŸæ ¼å¼è½‰æ›: ${record.date} -> ${targetDate}`);
          }
        }
        
        const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
        const sel = document.querySelector(selector);
        
        if(sel) {
          sel.value = record.status;
          sel.style.backgroundColor = '#ffffcc'; // æ¨™ç¤ºå·²è¼‰å…¥çš„è¨˜éŒ„
          loadedCount++;
          console.log(`âœ“ æˆåŠŸè¨­å®š: ${record.studentId} ${targetDate} = ${record.status}`);
        } else {
          notFoundCount++;
          console.warn(`âœ— æ‰¾ä¸åˆ°å°æ‡‰çš„é¸æ“‡æ¡†: ${record.studentId} ${targetDate}`);
          console.warn(`ä½¿ç”¨çš„é¸æ“‡å™¨: ${selector}`);
          console.warn(`åŸå§‹æ—¥æœŸ: ${record.date}, è½‰æ›å¾Œæ—¥æœŸ: ${targetDate}`);
        }
      });
      
      console.log(`è¼‰å…¥çµæœ: æˆåŠŸ ${loadedCount} ç­†, æ‰¾ä¸åˆ° ${notFoundCount} ç­†`);
      
      // æ¢å¾©å„²å­˜æŒ‰éˆ•
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜';
      }
      
      // é¡¯ç¤ºçµæœ
      let message = `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼Œ${loadedCount} ç­†æ—¢æœ‰è¨˜éŒ„`;
      if(notFoundCount > 0) {
        message += `ï¼Œ${notFoundCount} ç­†è¨˜éŒ„ç„¡æ³•å°æ‡‰`;
      }
      document.getElementById('msg').innerText = message;
    })
    .withFailureHandler(error => {
      console.error('è¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—:', error);
      
      // æ¢å¾©å„²å­˜æŒ‰éˆ•
      if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜';
      }
      
      document.getElementById('msg').innerText = 
        `è¼‰å…¥å®Œæˆï¼Œå…± ${meta.students.length} ä½å­¸ç”Ÿï¼Œ${meta.dates.length} å€‹ä¸Šèª²æ—¥ï¼ˆè¼‰å…¥æ—¢æœ‰è¨˜éŒ„å¤±æ•—: ${error.message})`;
    })
    .getExistingAttendance(group, month);
}


function tdEl(txt, tag, className){ 
  const el = document.createElement(tag || 'td'); 
  el.innerText = txt; 
  if(className) el.className = className;
  return el; 
}

function clearGrid(){ document.getElementById('grid').innerHTML=''; meta={students:[],dates:[],attendanceMap:{}}; document.getElementById('msg').innerText='å·²æ¸…é™¤è¡¨æ ¼'; }

function saveAll_v0_1(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  if(!meta.students.length||!meta.dates.length){ document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; return; }
  const table=document.querySelector('#grid table'); if(!table){ document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; return; }

  const records=[];
  table.querySelectorAll('tbody tr').forEach((tr,i)=>{
    const sid=meta.students[i].id;
    const selects=tr.querySelectorAll('select');
    selects.forEach((sel,j)=>{ 
      const val=sel.value||''; 
      if(val!=='') {
        // ğŸ¯ é—œéµä¿®æ­£ï¼šå»é™¤æ—¥æœŸä¸­çš„æ˜ŸæœŸè³‡è¨Š
        const fullDate = meta.dates[j];                    // "10/03 (å››)"
        const pureDate = fullDate.split(' ')[0];          // "10/03"
        
        records.push({
          studentId: sid,
          date: pureDate,  // åªä¿ç•™ç´”æ—¥æœŸéƒ¨åˆ†
          status: val
        }); 
      }
    });
  });

  if(records.length===0){ document.getElementById('msg').innerText='æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; return; }
  
  console.log('æº–å‚™å„²å­˜çš„è¨˜éŒ„:', records); // é™¤éŒ¯ç”¨
  document.getElementById('msg').innerText='å„²å­˜ä¸­...';

  google.script.run
    .withSuccessHandler(res=>{
      console.log('å„²å­˜æˆåŠŸå›æ‡‰:', res); // é™¤éŒ¯ç”¨
      document.getElementById('msg').innerText=res.message||'å„²å­˜å®Œæˆ';
    })
    .withFailureHandler(error=>{
      console.error('å„²å­˜å¤±æ•—:', error); // é™¤éŒ¯ç”¨
      document.getElementById('msg').innerText='å„²å­˜å¤±æ•—: ' + error.message;
    })
    .saveAttendance_v2({group:group,month:month,records:records});
}


function saveAll(){
  const group=document.getElementById('groupSel').value;
  const month=document.getElementById('monthSel').value;
  if(!group||!month){ document.getElementById('msg').innerText='è«‹å…ˆé¸çµ„åˆ¥èˆ‡æœˆä»½'; return; }
  if(!meta.students.length||!meta.dates.length){ document.getElementById('msg').innerText='å°šæœªç”¢ç”Ÿè¡¨æ ¼'; return; }
  const table=document.querySelector('#grid table'); if(!table){ document.getElementById('msg').innerText='å°šç„¡è¡¨æ ¼'; return; }

  console.log('=== é–‹å§‹å„²å­˜åˆ°å‡ºå¸­ç´€éŒ„å½™ç¸½ ===');
  console.log('çµ„åˆ¥:', group);
  console.log('æœˆä»½:', month);
  console.log('å‰ç«¯æ—¥æœŸæ ¼å¼:', meta.dates);
  console.log('å­¸ç”Ÿæ•¸é‡:', meta.students.length);

  // ğŸ¯ æ–°æ ¼å¼ï¼šæº–å‚™æ›´æ–°è³‡æ–™ï¼ŒåŒ…å«å­¸ç”Ÿè³‡è¨Šå’Œå‡ºå¸­è¨˜éŒ„
  const updateData = {
    group: group,
    month: month,
    students: meta.students,  // å­¸ç”Ÿå®Œæ•´è³‡è¨Š
    dates: meta.dates.map(date => date.split(' ')[0]),  // ç´”æ—¥æœŸæ ¼å¼
    attendanceGrid: []  // å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  };

  // å»ºç«‹å‡ºå¸­è¨˜éŒ„ç¶²æ ¼
  table.querySelectorAll('tbody tr').forEach((tr, studentIndex) => {
    const studentId = meta.students[studentIndex].id;
    const selects = tr.querySelectorAll('select');
    
    console.log(`è™•ç†å­¸ç”Ÿ ${studentIndex + 1}: ${studentId}`);
    
    const attendanceRow = [];
    selects.forEach((sel, dateIndex) => { 
      const val = sel.value || ''; 
      
      // ğŸ¯ è½‰æ›ç‚ºæ•¸å­—æ ¼å¼ï¼š0=è«‹å‡, 1=å‡ºå¸­, 2=è£œèª², ç©ºç™½=''
      let numericValue = '';
      if(val === 'è«‹å‡') numericValue = 0;
      else if(val === 'å‡ºå¸­') numericValue = 1;
      else if(val === 'è£œèª²') numericValue = 2;
      
      attendanceRow.push(numericValue);
      
      if(val !== '') {
        const fullDate = meta.dates[dateIndex];
        const pureDate = fullDate.split(' ')[0];
        console.log(`  è¨˜éŒ„ ${dateIndex + 1}: ${studentId} ${fullDate} -> ${pureDate} = ${val} (${numericValue})`);
      }
    });
    
    updateData.attendanceGrid.push(attendanceRow);
  });

  console.log('æº–å‚™æ›´æ–°çš„ç¶²æ ¼è³‡æ–™:', updateData);
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‡ºå¸­è¨˜éŒ„
  const hasAnyRecord = updateData.attendanceGrid.some(row => 
    row.some(cell => cell !== '')
  );
  
  if(!hasAnyRecord) { 
    console.warn('æ²’æœ‰ä»»ä½•è¨˜éŒ„è¦å„²å­˜');
    document.getElementById('msg').innerText = 'æ²’æœ‰ä»»ä½•è¦å„²å­˜çš„é …ç›®'; 
    return; 
  }
  
  document.getElementById('msg').innerText = 'æ­£åœ¨æ›´æ–°å‡ºå¸­ç´€éŒ„å½™ç¸½...';

  // ğŸ¯ å‘¼å«æ–°çš„å¾Œç«¯å‡½æ•¸ï¼šç›´æ¥æ›´æ–°å·¥ä½œè¡¨
  google.script.run
    .withSuccessHandler(res => {
      console.log('âœ… æ›´æ–°æˆåŠŸå›æ‡‰:', res);
      document.getElementById('msg').innerText = res.message || 'æ›´æ–°å®Œæˆ';
      
      // å„²å­˜æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ—¢æœ‰è¨˜éŒ„
      setTimeout(() => {
        loadExistingAttendance();
      }, 1000);
    })
    .withFailureHandler(error => {
      console.error('âŒ æ›´æ–°å¤±æ•—:', error);
      document.getElementById('msg').innerText = 'æ›´æ–°å¤±æ•—: ' + error.message;
    })
    //.updateAttendanceSummary(updateData);  // æ–°çš„å¾Œç«¯å‡½æ•¸
    .updateAttendanceSummary_optimized(updateData);  // ä½¿ç”¨å„ªåŒ–ç‰ˆæœ¬
  
  console.log('=== æ›´æ–°è«‹æ±‚å·²ç™¼é€ ===');
}



// ---------------------------------------------------------------------------------------
// æ¸¬è©¦
// ---------------------------------------------------------------------------------------

// æ–°å¢ï¼šæ¸¬è©¦é¸æ“‡å™¨åŠŸèƒ½
function testSelector() {
  console.log('=== é–‹å§‹æ¸¬è©¦é¸æ“‡å™¨åŠŸèƒ½ ===');
  
  // 1. æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
  const table = document.querySelector('#grid table');
  if (!table) {
    console.warn('âŒ è¡¨æ ¼ä¸å­˜åœ¨ï¼Œè«‹å…ˆé»é¸ã€Œç”¢ç”Ÿäº’å‹•è¡¨æ ¼ã€');
    document.getElementById('msg').innerText = 'è«‹å…ˆç”¢ç”Ÿè¡¨æ ¼å†æ¸¬è©¦';
    return;
  }
  
  // 2. åˆ—å‡ºæ‰€æœ‰ select å…ƒç´ 
  const selects = document.querySelectorAll('select[data-student][data-date]');
  console.log(`âœ… æ‰¾åˆ° ${selects.length} å€‹ select å…ƒç´ `);
  
  // 3. é¡¯ç¤ºå‰5å€‹ select å…ƒç´ çš„è©³ç´°è³‡è¨Š
  console.log('å‰5å€‹ select å…ƒç´ :');
  selects.forEach((sel, index) => {
    if (index < 5) {
      const studentId = sel.getAttribute('data-student');
      const date = sel.getAttribute('data-date');
      console.log(`  ${index + 1}. å­¸ç”Ÿ: ${studentId}, æ—¥æœŸ: ${date}`);
    }
  });
  
  // 4. æ¸¬è©¦é¸æ“‡å™¨æŸ¥æ‰¾
  if (selects.length > 0) {
    const firstSelect = selects[0];
    const testStudentId = firstSelect.getAttribute('data-student');
    const testDate = firstSelect.getAttribute('data-date');
    
    console.log(`\nğŸ§ª æ¸¬è©¦é¸æ“‡å™¨: å­¸ç”Ÿ=${testStudentId}, æ—¥æœŸ=${testDate}`);
    
    const testSelector = `select[data-student="${testStudentId}"][data-date="${testDate}"]`;
    console.log(`é¸æ“‡å™¨å­—ä¸²: ${testSelector}`);
    
    const foundElement = document.querySelector(testSelector);
    
    if (foundElement) {
      console.log('âœ… é¸æ“‡å™¨æ¸¬è©¦æˆåŠŸï¼æ‰¾åˆ°å°æ‡‰å…ƒç´ ');
      
      // 5. æ¸¬è©¦è¨­å®šå€¼
      const originalValue = foundElement.value;
      foundElement.value = 'å‡ºå¸­';
      foundElement.style.backgroundColor = '#90EE90'; // æ·ºç¶ è‰²
      
      console.log(`âœ… æ¸¬è©¦è¨­å®šå€¼æˆåŠŸï¼å¾ "${originalValue}" æ”¹ç‚º "${foundElement.value}"`);
      
      // 2ç§’å¾Œæ¢å¾©åŸå€¼
      setTimeout(() => {
        foundElement.value = originalValue;
        foundElement.style.backgroundColor = '';
        console.log('ğŸ”„ å·²æ¢å¾©åŸå§‹å€¼');
      }, 2000);
      
    } else {
      console.error('âŒ é¸æ“‡å™¨æ¸¬è©¦å¤±æ•—ï¼æ‰¾ä¸åˆ°å°æ‡‰å…ƒç´ ');
    }
  }
  
  // 6. æ¨¡æ“¬ä¸€ç­†è¨˜éŒ„æ¸¬è©¦
  console.log('\nğŸ¯ æ¨¡æ“¬è¨˜éŒ„æ¸¬è©¦:');
  const mockRecord = {
    studentId: meta.students[0]?.id || 'TEST_ID',
    date: meta.dates[0] || 'TEST_DATE',
    status: 'è£œèª²'
  };
  
  console.log(`æ¨¡æ“¬è¨˜éŒ„: ${mockRecord.studentId} ${mockRecord.date} = ${mockRecord.status}`);
  
  const mockSelector = `select[data-student="${mockRecord.studentId}"][data-date="${mockRecord.date}"]`;
  const mockElement = document.querySelector(mockSelector);
  
  if (mockElement) {
    mockElement.value = mockRecord.status;
    mockElement.style.backgroundColor = '#FFE4B5'; // æ·ºæ©˜è‰²
    console.log('âœ… æ¨¡æ“¬è¨˜éŒ„è¨­å®šæˆåŠŸï¼');
    
    // 3ç§’å¾Œæ¸…é™¤
    setTimeout(() => {
      mockElement.value = '';
      mockElement.style.backgroundColor = '';
      console.log('ğŸ”„ å·²æ¸…é™¤æ¨¡æ“¬è¨˜éŒ„');
    }, 3000);
  } else {
    console.warn('âŒ æ¨¡æ“¬è¨˜éŒ„æ¸¬è©¦å¤±æ•—');
  }
  
  document.getElementById('msg').innerText = `é¸æ“‡å™¨æ¸¬è©¦å®Œæˆï¼Œå…± ${selects.length} å€‹å…ƒç´ `;
  console.log('=== é¸æ“‡å™¨æ¸¬è©¦çµæŸ ===');
}

// æ–°å¢ï¼šæ¸¬è©¦å»ºè­°åŠŸèƒ½
function testSuggestions() {
  console.log('=== é–‹å§‹åŸ·è¡Œæ¸¬è©¦å»ºè­° ===');
  
  // 1. æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
  const table = document.querySelector('#grid table');
  if (!table) {
    console.warn('âŒ è¡¨æ ¼ä¸å­˜åœ¨ï¼Œè«‹å…ˆé»é¸ã€Œç”¢ç”Ÿäº’å‹•è¡¨æ ¼ã€');
    document.getElementById('msg').innerText = 'è«‹å…ˆç”¢ç”Ÿè¡¨æ ¼å†æ¸¬è©¦';
    return;
  }
  
  // 2. æ¸¬è©¦å‰ç«¯æ—¥æœŸæ ¼å¼
  console.log('ğŸ“… å‰ç«¯æ—¥æœŸæ ¼å¼æ¸¬è©¦:');
  console.log('å‰ç«¯æ—¥æœŸé™£åˆ—:', meta.dates);
  
  // æª¢æŸ¥æ—¥æœŸæ ¼å¼æ˜¯å¦åŒ…å«æ˜ŸæœŸ
  const hasWeekday = meta.dates.some(date => date.includes('('));
  console.log(`æ—¥æœŸæ ¼å¼åˆ†æ: ${hasWeekday ? 'åŒ…å«æ˜ŸæœŸ' : 'ç´”æ—¥æœŸæ ¼å¼'}`);
  
  // 3. æ¨¡æ“¬å¾Œç«¯æ—¥æœŸæ ¼å¼å·®ç•°æ¸¬è©¦
  console.log('\nğŸ§ª æ¨¡æ“¬å¾Œç«¯æ—¥æœŸæ ¼å¼æ¸¬è©¦:');
  const mockBackendRecords = [
    {studentId: meta.students[0]?.id || 'TEST_ID', date: '10/03', status: 'å‡ºå¸­'},     // ç´”æ—¥æœŸ
    {studentId: meta.students[0]?.id || 'TEST_ID', date: '10/03 (å››)', status: 'è£œèª²'}, // å«æ˜ŸæœŸ
  ];
  
  mockBackendRecords.forEach((record, index) => {
    console.log(`\næ¸¬è©¦è¨˜éŒ„ ${index + 1}: ${record.studentId} ${record.date} = ${record.status}`);
    
    // æ¨¡æ“¬æ—¥æœŸè½‰æ›é‚è¼¯
    let targetDate = record.date;
    
    if(!targetDate.includes('(')) {
      const matchedDate = meta.dates.find(frontendDate => {
        const frontendDateOnly = frontendDate.split(' ')[0];
        return frontendDateOnly === record.date;
      });
      
      if(matchedDate) {
        targetDate = matchedDate;
        console.log(`ğŸ”„ æ—¥æœŸæ ¼å¼è½‰æ›: ${record.date} -> ${targetDate}`);
      }
    }
    
    const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
    const element = document.querySelector(selector);
    
    if(element) {
      console.log(`âœ… æ‰¾åˆ°å°æ‡‰å…ƒç´ : ${selector}`);
      
      // å¯¦éš›æ¸¬è©¦è¨­å®šå€¼
      const originalValue = element.value;
      element.value = record.status;
      element.style.backgroundColor = index === 0 ? '#E8F5E8' : '#FFF3E0';
      
      console.log(`âœ… è¨­å®šæˆåŠŸ: "${originalValue}" -> "${element.value}"`);
      
      // å»¶é²æ¢å¾©
      setTimeout(() => {
        element.value = originalValue;
        element.style.backgroundColor = '';
        console.log(`ğŸ”„ å·²æ¢å¾©è¨˜éŒ„ ${index + 1} çš„åŸå§‹å€¼`);
      }, (index + 1) * 2000);
      
    } else {
      console.warn(`âŒ æ‰¾ä¸åˆ°å°æ‡‰å…ƒç´ : ${selector}`);
    }
  });
  
  // 4. æ¸¬è©¦æ‰€æœ‰å¯ç”¨é¸æ“‡å™¨çš„åŒ¹é…æ€§
  console.log('\nğŸ” é¸æ“‡å™¨åŒ¹é…æ€§åˆ†æ:');
  const selects = document.querySelectorAll('select[data-student][data-date]');
  
  let studentCount = {};
  let dateCount = {};
  
  selects.forEach(sel => {
    const studentId = sel.getAttribute('data-student');
    const date = sel.getAttribute('data-date');
    
    studentCount[studentId] = (studentCount[studentId] || 0) + 1;
    dateCount[date] = (dateCount[date] || 0) + 1;
  });
  
  console.log('å­¸ç”Ÿåˆ†å¸ƒ:', studentCount);
  console.log('æ—¥æœŸåˆ†å¸ƒ:', dateCount);
  console.log(`ç¸½å…± ${Object.keys(studentCount).length} ä½å­¸ç”Ÿ, ${Object.keys(dateCount).length} å€‹æ—¥æœŸ`);
  
  // 5. æ¸¬è©¦å¾Œç«¯è³‡æ–™æ¨¡æ“¬
  console.log('\nğŸ“Š æ¨¡æ“¬å¾Œç«¯è³‡æ–™è¼‰å…¥æ¸¬è©¦:');
  setTimeout(() => {
    testMockBackendData();
  }, 5000);
  
  document.getElementById('msg').innerText = `æ¸¬è©¦å»ºè­°åŸ·è¡Œå®Œæˆï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°è©³ç´°çµæœ`;
  console.log('=== æ¸¬è©¦å»ºè­°åŸ·è¡ŒçµæŸ ===');
}

// æ¨¡æ“¬å¾Œç«¯è³‡æ–™è¼‰å…¥æ¸¬è©¦
function testMockBackendData() {
  console.log('\nğŸ¯ æ¨¡æ“¬å®Œæ•´å¾Œç«¯è³‡æ–™è¼‰å…¥æµç¨‹:');
  
  // æ¨¡æ“¬çœŸå¯¦çš„å¾Œç«¯å›å‚³æ ¼å¼
  const mockRecords = [];
  
  // ç‚ºæ¯å€‹å­¸ç”Ÿçš„å‰3å€‹æ—¥æœŸå»ºç«‹æ¨¡æ“¬è¨˜éŒ„
  meta.students.slice(0, 2).forEach(student => {
    meta.dates.slice(0, 3).forEach((date, index) => {
      const statuses = ['å‡ºå¸­', 'è«‹å‡', 'è£œèª²'];
      const pureDate = date.split(' ')[0]; // ç§»é™¤æ˜ŸæœŸéƒ¨åˆ†
      
      mockRecords.push({
        studentId: student.id,
        date: pureDate, // å¾Œç«¯å›å‚³ç´”æ—¥æœŸæ ¼å¼
        status: statuses[index % 3]
      });
    });
  });
  
  console.log('æ¨¡æ“¬å¾Œç«¯è¨˜éŒ„:', mockRecords);
  
  // åŸ·è¡Œè¼‰å…¥é‚è¼¯æ¸¬è©¦
  let successCount = 0;
  let failCount = 0;
  
  mockRecords.forEach(record => {
    // æ—¥æœŸè½‰æ›é‚è¼¯
    let targetDate = record.date;
    
    if(!targetDate.includes('(')) {
      const matchedDate = meta.dates.find(frontendDate => {
        const frontendDateOnly = frontendDate.split(' ')[0];
        return frontendDateOnly === record.date;
      });
      
      if(matchedDate) {
        targetDate = matchedDate;
      }
    }
    
    const selector = `select[data-student="${record.studentId}"][data-date="${targetDate}"]`;
    const element = document.querySelector(selector);
    
    if(element) {
      element.value = record.status;
      element.style.backgroundColor = '#FFFFCC';
      successCount++;
      console.log(`âœ… è¼‰å…¥æˆåŠŸ: ${record.studentId} ${targetDate} = ${record.status}`);
    } else {
      failCount++;
      console.warn(`âŒ è¼‰å…¥å¤±æ•—: ${record.studentId} ${targetDate}`);
    }
  });
  
  console.log(`\nğŸ“ˆ æ¨¡æ“¬è¼‰å…¥çµæœ: æˆåŠŸ ${successCount} ç­†, å¤±æ•— ${failCount} ç­†`);
  
  // 5ç§’å¾Œæ¸…é™¤æ‰€æœ‰æ¨¡æ“¬è³‡æ–™
  setTimeout(() => {
    const allSelects = document.querySelectorAll('select[data-student][data-date]');
    allSelects.forEach(sel => {
      sel.value = '';
      sel.style.backgroundColor = '';
    });
    console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰æ¨¡æ“¬è³‡æ–™');
  }, 5000);
}

// æ–°å¢ï¼šæ¸¬è©¦æ—¥æœŸæ ¼å¼ç›¸å®¹æ€§
function testDateCompatibility() {
  console.log('=== æ—¥æœŸæ ¼å¼ç›¸å®¹æ€§æ¸¬è©¦ ===');
  
  const testDates = [
    '10/03',         // ç´”æ—¥æœŸ
    '10/03 (å››)',    // å«æ˜ŸæœŸ
    '10/3',          // ä¸è£œé›¶
    '10/3 (å››)',     // ä¸è£œé›¶å«æ˜ŸæœŸ
  ];
  
  testDates.forEach(testDate => {
    console.log(`\næ¸¬è©¦æ—¥æœŸ: "${testDate}"`);
    
    // æ¸¬è©¦æ˜¯å¦èƒ½åœ¨å‰ç«¯æ—¥æœŸä¸­æ‰¾åˆ°åŒ¹é…
    const matched = meta.dates.find(frontendDate => {
      const frontendDateOnly = frontendDate.split(' ')[0];
      return frontendDateOnly === testDate || frontendDateOnly === testDate.split(' ')[0];
    });
    
    if(matched) {
      console.log(`âœ… æ‰¾åˆ°åŒ¹é…: "${testDate}" -> "${matched}"`);
      
      // æ¸¬è©¦é¸æ“‡å™¨
      const selector = `select[data-student="${meta.students[0]?.id}"][data-date="${matched}"]`;
      const element = document.querySelector(selector);
      console.log(`é¸æ“‡å™¨æ¸¬è©¦: ${element ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
      
    } else {
      console.warn(`âŒ ç„¡æ³•åŒ¹é…: "${testDate}"`);
    }
  });
  
  console.log('=== æ—¥æœŸæ ¼å¼ç›¸å®¹æ€§æ¸¬è©¦çµæŸ ===');
}



window.onload=init;
</script>
</body>
</html>
